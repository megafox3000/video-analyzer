// analyze.js

// –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ 'YOUR_CLIENT_ID' –Ω–∞ –≤–∞—à —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π Client ID –∏–∑ Google Cloud Console
const CLIENT_ID = 'YOUR_CLIENT_ID';
const API_KEY = ''; // –î–ª—è Google Drive API –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–µ–Ω API Key –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OAuth.
                    // –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥—Ä—É–≥–∏–µ API, —Ç—Ä–µ–±—É—é—â–∏–µ –µ–≥–æ.

// –û–±–ª–∞—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞ (scopes) –¥–ª—è Google Drive API
// 'https://www.googleapis.com/auth/drive.file' - –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Ñ–∞–π–ª–∞–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–º —ç—Ç–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
// 'https://www.googleapis.com/auth/drive.upload' - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.upload';

let tokenClient;
let gapiInited = false;
let gsiInited = false;

// –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã upload.html
const authorizeButton = document.getElementById('authorize_button');
const signoutButton = document.getElementById('signout_button');
const uploadSection = document.getElementById('upload-section'); // –≠—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª–µ–Ω, –µ—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –µ–≥–æ –≤ —Ç–µ–∫—É—â–µ–º upload.html
const fileInput = document.getElementById('videoUpload'); // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ 'videoUpload'
const uploadButton = document.getElementById('uploadButton'); // –í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GD
const uploadLabel = document.getElementById('videoUpload'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º label –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ input file
const uploadStatus = document.getElementById('uploadStatus'); // –î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏

const spoilerBtn = document.getElementById('spoilerBtn');
const metadataContent = document.getElementById('metadataContent');
const fileNameSpan = document.getElementById('fileName'); // –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ø–æ–π–ª–µ—Ä–µ
const videoInfoContainer = document.getElementById('videoInfo'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google API Client Library (gapi)
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ gapi
async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤—ã–∑–æ–≤ maybeEnableButtons()
    // –∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏
    // maybeEnableButtons();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Identity Services (GSI) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
function gsiLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ –≤ handleAuthClick
    });
    gsiInited = true;
    // maybeEnableButtons();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Drive)
// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —Å Google"
async function handleGoogleAuth() {
    return new Promise((resolve, reject) => {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                console.error('Authorization error:', resp);
                reject(new Error('Authorization failed. Check console for details.'));
            } else {
                console.log('Authorized successfully!');
                resolve();
            }
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –Ω–∞ Google –î–∏—Å–∫
async function uploadFileToDrive(file) {
    if (!file) {
        uploadStatus.textContent = 'No file selected for upload.';
        return;
    }

    uploadStatus.textContent = 'Authorizing with Google...';
    try {
        await handleGoogleAuth(); // –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è

        uploadStatus.textContent = 'Uploading to Google Drive...';
        // uploadButton.disabled = true; // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        uploadLabel.style.pointerEvents = 'none'; // –û—Ç–∫–ª—é—á–∞–µ–º label –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        uploadLabel.style.opacity = '0.7';

        const metadata = {
            name: file.name,
            mimeType: file.type,
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
            body: form,
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Upload failed: ${response.status} ${response.statusText} - ${errorData.error.message}`);
        }

        const data = await response.json();
        uploadStatus.textContent = `File uploaded successfully! File ID: ${data.id}`;
        console.log('Uploaded file to Google Drive:', data);
        // fileInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞

    } catch (error) {
        uploadStatus.textContent = `Error during Google Drive upload: ${error.message}`;
        console.error('Google Drive upload error:', error);
    } finally {
        // uploadButton.disabled = false;
        uploadLabel.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º label –æ–±—Ä–∞—Ç–Ω–æ
        uploadLabel.style.opacity = '1';
    }
}


// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞) ---
fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        uploadStatus.textContent = `Selected file: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
        videoInfoContainer.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∏–¥–µ–æ

        // –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Google Drive
        uploadFileToDrive(file);

        // –ò–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        getMetadata(file);
    } else {
        uploadStatus.textContent = 'No file selected.';
        videoInfoContainer.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω
    }
});

// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ (–ø—Ä–∏–º–µ—Ä) ---
function getMetadata(file) {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MediaSource API –∏–ª–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤–∏–¥–µ–æ
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
    const metadataHtml = `
        <p><strong>Name:</strong> ${file.name}</p>
        <p><strong>Type:</strong> ${file.type}</p>
        <p><strong>Size:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
        <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleDateString()}</p>
        <p><em>(More detailed video analysis would go here)</em></p>
    `;
    metadataContent.innerHTML = metadataHtml;
    fileNameSpan.textContent = file.name; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–ø–æ–π–ª–µ—Ä–∞ –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–ø–æ–π–ª–µ—Ä –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    metadataContent.classList.remove('visible');
    fileNameSpan.textContent = 'üìÅ ' + file.name + ' Metadata';
}


// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ø–æ–π–ª–µ—Ä–∞ ---
function toggleSpoiler() {
    metadataContent.classList.toggle('visible');
    if (metadataContent.classList.contains('visible')) {
        fileNameSpan.textContent = 'üìÇ ' + fileNameSpan.textContent.replace('üìÅ ', '').replace(' Metadata', '') + ' Metadata (Hide)';
    } else {
        fileNameSpan.textContent = 'üìÅ ' + fileNameSpan.textContent.replace('üìÇ ', '').replace(' Metadata (Hide)', '') + ' Metadata';
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–ø–æ–π–ª–µ—Ä–∞
if (spoilerBtn) {
    spoilerBtn.addEventListener('click', toggleSpoiler);
}

// --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π (–ø—Ä–∏–º–µ—Ä) ---
const socialForm = document.querySelector('.social-form');
if (socialForm) {
    socialForm.addEventListener('submit', (event) => {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

        const instagram = document.getElementById('instagramInput').value;
        const linkedin = document.getElementById('linkedinInput').value;
        const email = document.getElementById('emailInput').value;

        console.log('Socials submitted:', { instagram, linkedin, email });
        // –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ
        alert('Socials saved! (This is a demo alert, replace with better UI)');
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –¥—Ä—É–≥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ alert()
    });
}


// –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ gapi –∏ gsi –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
// –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ <script> —Ç–µ–≥–æ–≤ –≤ upload.html
// window.gapiLoaded = gapiLoaded;
// window.gsiLoaded = gsiLoaded;
